<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Diagnostic - CarConnect Ghana</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            color: blue;
            background: #e6f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Error Diagnostic Tool</h1>
        <p>This tool helps diagnose issues in your CarConnect Ghana application.</p>
        
        <div class="section">
            <h2>üö® Recent Errors</h2>
            <div id="recentErrors"></div>
        </div>
        
        <div class="section">
            <h2>üîß Diagnostic Tests</h2>
            <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
            <button onclick="testAuthState()">Test Auth State</button>
            <button onclick="testLocalStorage()">Test Local Storage</button>
            <button onclick="testEnvironment()">Test Environment</button>
            <button onclick="clearErrors()">Clear Errors</button>
        </div>
        
        <div class="section">
            <h2>üìä Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://gyafbexyaenvkmsrrrqh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YWZiZXh5YWVudmttc3JycnFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MTM0OTYsImV4cCI6MjA4NDk4OTQ5Nn0.MOGiOnZWogGYsGV_1JZkKTzIul4ZRjWgDpvMQKDvKXg';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        const results = document.getElementById('results');
        const recentErrors = document.getElementById('recentErrors');
        
        const errorLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            errorLog.push({ timestamp, message, type });
            
            results.innerHTML += `<div class="${type}">${entry}</div>`;
            results.scrollTop = results.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function logError(error, context = '') {
            const message = context ? `${context}: ${error.message}` : error.message;
            log(message, 'error');
            
            // Add to recent errors
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            recentErrors.appendChild(errorDiv);
            
            // Keep only last 5 errors
            while (recentErrors.children.length > 5) {
                recentErrors.removeChild(recentErrors.firstChild);
            }
        }
        
        // Override console.error to capture errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logError(new Error(args.join(' ')), 'Console Error');
        };
        
        // Override console.warn to capture warnings
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logError(new Error(args.join(' ' ')), 'Console Warning');
        };
        
        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            logError(event.reason, 'Unhandled Promise Rejection');
            event.preventDefault();
        });
        
        // Capture global errors
        window.addEventListener('error', function(event) {
            logError(new Error(event.message), 'Global Error');
        });
        
        function testSupabaseConnection() {
            log('üîç Testing Supabase connection...');
            
            try {
                // Test basic connection
                supabase.from('users').select('count').then(({ data, error }) => {
                    if (error) {
                        logError(error, 'Supabase Connection Test');
                    } else {
                        log('‚úÖ Supabase connection successful!', 'success');
                        log(`Data: ${JSON.stringify(data)}`, 'info');
                    }
                }).catch(error => {
                    logError(error, 'Supabase Connection Test');
                });
            } catch (e) {
                    logError(e, 'Supabase Connection Test');
                }
        }
        
        function testAuthState() {
            log('üîê Testing auth state...');
            
            try {
                supabase.auth.getSession().then(({ data: { session }, error }) => {
                    if (error) {
                        logError(error, 'Auth State Test');
                    } else {
                        log('‚úÖ Auth state retrieved', 'success');
                        log(`Session exists: ${!!session}`, 'info');
                        if (session) {
                            log(`User: ${session.user?.email}`, 'info');
                            log(`Expires: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info');
                        }
                    }
                }).catch(error => {
                    logError(error, 'Auth State Test');
                });
            } catch (e) {
                logError(e, 'Auth State Test');
            }
        }
        
        function testLocalStorage() {
            log('üíæ Testing local storage...');
            
            try {
                // Test localStorage availability
                const testKey = 'test-key';
                const testValue = 'test-value';
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                
                if (retrieved === testValue) {
                    log('‚úÖ Local storage working', 'success');
                } else {
                    log('‚ùå Local storage not working', 'error');
                }
                
                localStorage.removeItem(testKey);
                
                // Check for existing auth data
                const user = localStorage.getItem('user');
                const token = localStorage.getItem('token');
                
                if (user || token) {
                    log('üìù Found existing auth data in localStorage', 'info');
                    log(`User exists: ${!!user}`, 'info');
                    log(`Token exists: ${!!token}`, 'info');
                } else {
                    log('‚ÑπÔ∏è No auth data in localStorage', 'info');
                }
            } catch (e) {
                    logError(e, 'Local Storage Test');
                }
        }
        
        function testEnvironment() {
            log('üåç Testing environment variables...');
            
            const envVars = {
                'VITE_SUPABASE_URL': import.meta.env.VITE_SUPABASE_URL,
                'VITE_SUPABASE_ANON_KEY': import.meta.env.VITE_SUPABASE_ANON_KEY,
                'VITE_API_URL': import.meta.env.VITE_API_URL,
                'VITE_PAYSTACK_PUBLIC_KEY': import.meta.env.VITE_PAYSTACK_PUBLIC_KEY,
                'VITE_APP_URL': import.meta.env.VITE_APP_URL
            };
            
            let allPresent = true;
            for (const [key, value] of Object.entries(envVars)) {
                if (value) {
                    log(`‚úÖ ${key}: ${value.substring(0, 20)}...`, 'success');
                } else {
                    log(`‚ùå ${key}: Missing`, 'error');
                    allPresent = false;
                }
            }
            
            if (allPresent) {
                log('‚úÖ All environment variables present', 'success');
            } else {
                log('‚ö†Ô∏è Some environment variables missing', 'error');
            }
        }
        
        function clearErrors() {
            errorLog.length = 0;
            results.innerHTML = '';
            recentErrors.innerHTML = '';
            log('üßπ Error log cleared', 'info');
        }
        
        // Run initial tests
        log('üîç Error diagnostic tool loaded', 'info');
        log('üìä Monitoring for errors...', 'info');
        
        // Test environment on load
        setTimeout(() => {
            testEnvironment();
            testLocalStorage();
        }, 1000);
    </script>
</body>
</html>
